name: "Linux Build"

inputs:
  use_mumps:
    description: 'Indicates if GMGPolar should be built with mumps support'
    type: bool
    required: true

runs:
  using: "composite"
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        apt-get -qq update
        apt-get -qq -y install lcov
        echo "${{ inputs.use_mumps }}"
        echo "${{ inputs.use_mumps == 'true'}}"
    - name: Install MUMPS
      shell: bash
      if: inputs.use_mumps == 'true'
      run: |
        apt-get -qq -y install gfortran
        git clone -b v5.1.0.4 https://github.com/scivision/METIS.git
        cd METIS
        cmake -Bbuild
        cmake --build build
        ls build
        ls build/*
        cd ..
        git clone https://github.com/cfwen/mumps.git
        cd mumps
        cp Make.inc/Makefile.inc.generic.SEQ ./Makefile.inc
        sed -i 's/^OPTF.*/& -fopenmp/g' Makefile.inc
        sed -i 's/^OPTC.*/& -fopenmp/g' Makefile.inc
        sed -i 's/^OPTL.*/& -fopenmp/g' Makefile.inc
        sed -i 's/^#LMETISDIR.*/LMETISDIR = $(topdir)\/..\/metis\/build\/lib/g' Makefile.inc
        sed -i 's/^#IMETIS.*/IMETIS = $(topdir)\/..\/metis\/include/g' Makefile.inc
        sed -i 's/^ORDERINGSF.*/ORDERINGSF = -Dpord -Dmetis/g' Makefile.inc
        sed -i 's/^CC.*/CC = gcc/g' Makefile.inc
        sed -i 's/^FC.*/FC = gfortran/g' Makefile.inc
        sed -i 's/^FL.*/FL = gfortran/g' Makefile.inc
        make s
        make d
        ls
        echo $LD_LIBRARY_PATH
        echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$(pwd)/lib"
        #spack install mumps@5.5.1 ~blr_mt ~complex +double +float ~incfort ~int64 +metis ~mpi +openmp ~parmetis ~ptscotch ~scotch +shared
    - name: Build
      shell: bash
      # ensure that the installed compiler version is used
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Debug -DGMGPOLAR_ENABLE_COVERAGE=ON -DGMGPOLAR_USE_MUMPS=${{ inputs.use_mumps }} ..
        make -j4
    - name: create build dir archive
      shell: bash
      run: |
        tar -czf build.tar.gz build
    - name: Upload build dir archive
      if: inputs.use_mumps == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-cpp-linux-gmgpolar-mumps
        path: build.tar.gz
        retention-days: 1
    - name: Upload build dir archive
      if: inputs.use_mumps != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-cpp-linux-gmgpolar
        path: build.tar.gz
        retention-days: 1
