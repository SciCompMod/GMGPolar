name: "Linux Build"

inputs:
  use-mumps:
    description: 'Indicates if GMGPolar should be built with mumps support'
    type: bool
    required: true

runs:
  using: "composite"
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        apt-get -qq update
        apt-get -qq -y install lcov
        echo "${{ inputs.use-mumps }}"
        echo "${{ inputs.use-mumps == 'true'}}"
    - name: Install MUMPS
      shell: bash
      if: inputs.use-mumps == 'true'
      run: |
        apt-get -qq -y install gfortran
        git clone -b v5.1.0.4 https://github.com/scivision/METIS.git
        cd METIS
        cmake -Bbuild -DCMAKE_INSTALL_PREFIX=$(pwd)/install
        cmake --build build
        cmake --install build
        ls build
        ls build/*
        cd ..
        git clone https://github.com/cfwen/mumps.git
        cd mumps
        cp Make.inc/Makefile.inc.generic.SEQ ./Makefile.inc
        sed -i 's|^OPTF.*|& -fopenmp -fallow-argument-mismatch|g' Makefile.inc
        sed -i 's|^OPTC.*|& -fopenmp|g' Makefile.inc
        sed -i 's|^OPTL.*|& -fopenmp|g' Makefile.inc
        sed -i "s|^#LMETISDIR.*|LMETISDIR = $(pwd)/../METIS/install/lib|g" Makefile.inc
        sed -i "s|^#IMETIS.*|IMETIS = -I$(pwd)/../METIS/install/include|g" Makefile.inc
        sed -i 's|^#LMETIS *= -L$(LMETISDIR) -lmetis|LMETIS = -L$(LMETISDIR) -lmetis|g' Makefile.inc
        sed -i 's|^ORDERINGSF.*|ORDERINGSF = -Dpord -Dmetis|g' Makefile.inc
        sed -i 's|^CC.*|CC = gcc|g' Makefile.inc
        sed -i 's|^FC.*|FC = gfortran|g' Makefile.inc
        sed -i 's|^FL.*|FL = gfortran|g' Makefile.inc
        sed -i "s|\$(topdir)|$(pwd)|g" Makefile.inc
        mkdir lib
        make s
        make d
        ls
        echo $LD_LIBRARY_PATH
        echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$(pwd)/lib"
        #spack install mumps@5.5.1 ~blr_mt ~complex +double +float ~incfort ~int64 +metis ~mpi +openmp ~parmetis ~ptscotch ~scotch +shared
    - name: Build
      shell: bash
      # ensure that the installed compiler version is used
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Debug -DGMGPOLAR_ENABLE_COVERAGE=ON -DGMGPOLAR_USE_MUMPS=${{ inputs.use-mumps }} ..
        make -j4
    - name: create build dir archive
      shell: bash
      run: |
        tar -czf build.tar.gz build
    - name: Upload build dir archive
      uses: actions/upload-artifact@v4
      with:
        name: build-cpp-linux-gmgpolar${{ inputs.use-mumps == 'true' && '-mumps' || ''}}
        path: build.tar.gz
        retention-days: 1
